#!/bin/bash
# üöÄ –ü–æ–ª–Ω—ã–π —Ç–µ—Å—Ç Ambient Agent —Å cursor-agent

set -e

echo "üöÄ –ü–æ–ª–Ω—ã–π —Ç–µ—Å—Ç Ambient Agent..."

# –ü—Ä–æ–≤–µ—Ä—è–µ–º venv
if [ ! -d "venv" ]; then
    echo "‚ùå Venv –Ω–µ –Ω–∞–π–¥–µ–Ω. –ó–∞–ø—É—Å–∫–∞—é wizard —Å–Ω–∞—á–∞–ª–∞..."
    ./wizard
fi

source venv/bin/activate

echo "ü§ñ –ó–∞–ø—É—Å–∫–∞—é cursor-agent –≤ —Ñ–æ–Ω–µ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è..."

# –ó–∞–ø—É—Å–∫–∞–µ–º cursor-agent –≤ —Ñ–æ–Ω–µ
cursor-agent "–ü—Ä–∏–≤–µ—Ç! Ambient agent —Ç–µ—Å—Ç. –ñ–¥—É —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ workflow..." --print > /tmp/cursor-agent-output.log 2>&1 &
CURSOR_PID=$!

echo "‚úÖ Cursor-agent –∑–∞–ø—É—â–µ–Ω (PID: $CURSOR_PID)"
echo "‚è≥ –ñ–¥—É 3 —Å–µ–∫—É–Ω–¥—ã –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏..."
sleep 3

echo "üß™ –°–∏–º—É–ª–∏—Ä—É—é workflow —Å–æ–±—ã—Ç–∏–µ..."

# –°–∏–º—É–ª–∏—Ä—É–µ–º —Å–æ–±—ã—Ç–∏–µ
python -c "
import sys
sys.path.append('github_mcp_server')
from ambient import AmbientAgent
from ambient.event_system import EventType
from pathlib import Path
import time

agent = AmbientAgent(Path.cwd())

# –°–∏–º—É–ª–∏—Ä—É–µ–º workflow —Å–æ–±—ã—Ç–∏–µ
agent.event_system.emit_simple(
    event_type=EventType.GITHUB_WORKFLOW_EVENT,
    source='full_test',
    data={
        'workflow_name': 'DonutBuffer CI',
        'run_number': 777,
        'status': 'completed',
        'conclusion': 'failure',
        'event_type': '–∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –æ—à–∏–±–∫–æ–π',
        'html_url': 'https://github.com/gitmur444/DonutBuffer/actions/runs/777'
    },
    priority=3
)

# –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–æ–±—ã—Ç–∏–µ
if agent.event_system.event_queue:
    event = agent.event_system.event_queue.pop(0)
    agent.event_system.process_event(event)
    print('‚úÖ Workflow —Å–æ–±—ã—Ç–∏–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ!')
"

echo "‚è≥ –ñ–¥—É 2 —Å–µ–∫—É–Ω–¥—ã –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è..."
sleep 2

echo "üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã:"
echo "   Cursor-agent –ª–æ–≥: /tmp/cursor-agent-output.log"
echo "   Ambient —Ñ–∞–π–ª—ã: ~/.cursor/ambient/"

# –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —á—Ç–æ –±—ã–ª–æ –≤ –ª–æ–≥–∞—Ö cursor-agent
if [ -f "/tmp/cursor-agent-output.log" ]; then
    echo ""
    echo "üìÑ –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏ –∏–∑ cursor-agent:"
    tail -10 /tmp/cursor-agent-output.log || echo "–õ–æ–≥ –ø—É—Å—Ç –∏–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
fi

# –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º cursor-agent
kill $CURSOR_PID 2>/dev/null || echo "Cursor-agent —É–∂–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"

echo ""
echo "üéâ –ü–æ–ª–Ω—ã–π —Ç–µ—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω!"
echo "üí° –ï—Å–ª–∏ –≤–∏–¥–∏—Ç–µ JSON —Å –ø—Ä–æ–º–ø—Ç–æ–º –≤—ã—à–µ - ambient agent —Ä–∞–±–æ—Ç–∞–µ—Ç!" 