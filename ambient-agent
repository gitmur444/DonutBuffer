#!/bin/bash
# ü§ñ DonutBuffer Ambient Agent Launcher
# –ó–∞–ø—É—Å–∫–∞–µ—Ç —Ñ–æ–Ω–æ–≤—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ GitHub –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑

set -e

echo "ü§ñ DonutBuffer Ambient Agent"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –º—ã –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
if [ ! -f "github_mcp_server/ambient/ambient_agent.py" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç –∏–∑ –∫–æ—Ä–Ω—è DonutBuffer –ø—Ä–æ–µ–∫—Ç–∞"
    exit 1
fi

# –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è
if [ ! -d "venv" ]; then
    echo "üîß –°–æ–∑–¥–∞—é –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ..."
    python3 -m venv venv
fi

source venv/bin/activate

if [ ! -f "venv/.requirements_installed" ]; then
    echo "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏..."
    pip install requests
    touch venv/.requirements_installed
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞—Ä–≥—É–º–µ–Ω—Ç—ã
case "${1:-start}" in
    "start")
        echo "üöÄ –ó–∞–ø—É—Å–∫–∞—é Ambient Agent..."
        python github_mcp_server/ambient/ambient_agent.py
        ;;
    "test")
        echo "üß™ –¢–µ—Å—Ç–∏—Ä—É—é —Å–∏—Å—Ç–µ–º—É..."
        python -c "
import sys
sys.path.append('github_mcp_server')
from ambient import AmbientAgent
from pathlib import Path

print('‚úÖ –ò–º–ø–æ—Ä—Ç —É—Å–ø–µ—à–µ–Ω')
agent = AmbientAgent(Path.cwd())
print('‚úÖ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞')

# –¢–µ—Å—Ç–∏—Ä—É–µ–º —Å–∏—Å—Ç–µ–º—É —Å–æ–±—ã—Ç–∏–π –æ—Ç–¥–µ–ª—å–Ω–æ
print('')
print('üß™ –ó–∞–ø—É—Å–∫–∞—é —Ç–µ—Å—Ç —Å–∏—Å—Ç–µ–º—ã —Å–æ–±—ã—Ç–∏–π...')
success = agent.test_event_system()

print('')
if success:
    print('üéâ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã! –°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞–±–æ—Ç–µ!')
else:
    print('‚ùå –¢–µ—Å—Ç—ã –Ω–µ –ø—Ä–æ–π–¥–µ–Ω—ã. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏.')
    sys.exit(1)
"
        ;;
    "status")
        echo "üìä –ü—Ä–æ–≤–µ—Ä—è—é —Å—Ç–∞—Ç—É—Å –ø—Ä–æ—Ü–µ—Å—Å–æ–≤..."
        ps aux | grep ambient_agent.py | grep -v grep || echo "üî¥ Ambient Agent –Ω–µ –∑–∞–ø—É—â–µ–Ω"
        ;;
    "stop")
        echo "üõë –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é Ambient Agent..."
        pkill -f ambient_agent.py 2>/dev/null || echo "‚ÑπÔ∏è  –ü—Ä–æ—Ü–µ—Å—Å –Ω–µ –Ω–∞–π–¥–µ–Ω"
        ;;
    "event-test")
        echo "üß™ –¢–µ—Å—Ç–∏—Ä—É—é —Ç–æ–ª—å–∫–æ —Å–∏—Å—Ç–µ–º—É —Å–æ–±—ã—Ç–∏–π..."
        python -c "
import sys
sys.path.append('github_mcp_server')
from ambient import AmbientAgent
from pathlib import Path

agent = AmbientAgent(Path.cwd())
success = agent.test_event_system()

if success:
    print('‚úÖ –°–∏—Å—Ç–µ–º–∞ —Å–æ–±—ã—Ç–∏–π —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ!')
else:
    print('‚ùå –°–∏—Å—Ç–µ–º–∞ —Å–æ–±—ã—Ç–∏–π –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç!')
    sys.exit(1)
"
        ;;
    *)
        echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: $0 [start|test|status|stop|event-test]"
        echo ""
        echo "–ö–æ–º–∞–Ω–¥—ã:"
        echo "  start      - –ó–∞–ø—É—Å–∫ ambient agent (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)"
        echo "  test       - –ü–æ–ª–Ω—ã–π —Ç–µ—Å—Ç —Å–∏—Å—Ç–µ–º—ã"
        echo "  event-test - –¢–µ—Å—Ç —Ç–æ–ª—å–∫–æ —Å–∏—Å—Ç–µ–º—ã —Å–æ–±—ã—Ç–∏–π"  
        echo "  status     - –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞"
        echo "  stop       - –û—Å—Ç–∞–Ω–æ–≤–∫–∞ agent"
        ;;
esac 